<!DOCTYPE html>
<html>
<head>
    <title>Carabande</title>
    <script src="https://unpkg.com/konva@9/konva.min.js"></script>
</head>
<body>
<div id="canvas"></div>
</body>
<script>
    const nobLength = 9;
    const snapZone = 10;
    var stage = new Konva.Stage({
        container: 'canvas',   // id of container <div>
        width: window.innerWidth,
        height: window.innerHeight
    });
    stage.on('contextmenu', function (e) {
        // prevent default behavior
        e.evt.preventDefault();
    });
    var layer = new Konva.Layer();
    stage.add(layer);

    function setCanvasSize(w, h) {
        stage.width(w);
        stage.height(h);
    }

    // listen to resize
    window.onresize = () => setCanvasSize(window.innerWidth, window.innerHeight);

    function haveIntersection(r1, r2) {
        return !(
            r2.x > r1.x + r1.width ||
            r2.x + r2.width < r1.x ||
            r2.y > r1.y + r1.height ||
            r2.y + r2.height < r1.y
        );
    }

    function addTrack(url, x, y) {
        Konva.Image.fromURL(url, function (track) {
            var group = new Konva.Group({
                x: x,
                y: y,
                draggable: true,
            });
            let width = track.width();
            let height = track.height();
            track.setAttrs({
                tag: "track",
                offsetX: width / 2,
                offsetY: height / 2,
            });
            group.add(track);

            group.on("mousedown", (e) => {
                if (e.evt.button != 2)
                    return;
                group.rotate(45);
            });

            function toggleSnapzones(val) {
                layer.getChildren().forEach((group) => {
                    group.getChildren().forEach((child) => {
                        if (child.attrs.tag != "snapzone")
                            return;
                        child.visible(val);
                    })
                })
            }

            function checkSnap() {
                let topRect = snapTop.getClientRect();
                let bottomRect = snapBottom.getClientRect();
                let groups = layer.getChildren();
                for (let i in groups) {
                    let g = groups[i];
                    // do not check intersection with itself
                    if (g === group)
                        continue;
                    let children = g.getChildren();
                    let otherTrack = children.find(n => n.attrs.tag == "track");
                    let snapzones = children.filter(n => n.attrs.tag == "snapzone");
                    let top = snapzones[0];
                    let bottom = snapzones[1];
                    if (haveIntersection(bottom.getClientRect(), topRect)) {
                        // move ourself
                        group.position({x: g.x(), y: (g.y() + otherTrack.height() - nobLength * 2)});
                        break;
                    }
                    if (haveIntersection(top.getClientRect(), bottomRect)) {
                        // move ourself
                        group.position({x: g.x(), y: (g.y() - otherTrack.height() + nobLength * 2)});
                        break;
                    }
                }
            }

            group.on("dragstart", () => {
                toggleSnapzones(true);
            });
            group.on("dragend", () => {
                toggleSnapzones(false);
                checkSnap();
            });

            let snapTop = new Konva.Rect({
                x: -width / 2 - snapZone,
                y: -height / 2 - snapZone,
                width: width + snapZone * 2,
                height: snapZone * 3,
                stroke: "red",
                strokeWidth: 1,
                visible: false,
                tag: "snapzone"
            });
            group.add(snapTop);
            let snapBottom = new Konva.Rect({
                x: -width / 2 - snapZone,
                y: height / 2 - snapZone * 2,
                width: width + snapZone * 2,
                height: snapZone * 3,
                stroke: "red",
                strokeWidth: 1,
                visible: false,
                tag: "snapzone"
            });
            group.add(snapBottom);
            layer.add(group);
        });
    }

    addTrack("assets/straight.png", 100, 80);
    addTrack("assets/start.png", 200, 80);
</script>
</html>