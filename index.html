<html>
<head>
    <title>Carabande</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ocanvas/2.10.1/ocanvas.min.js"></script>
</head>
<body>
<canvas id="canvas"></canvas>
</body>
<script>
    const nobLength = 9;
    const snapZone = 10;
    let domObject = document.getElementById("canvas");
    let canvas = oCanvas.create({
        canvas: "#canvas",
    });
    // Disable context menu
    domObject.oncontextmenu = function (e) {
        e.preventDefault();
    };

    function setCanvasSize(w, h) {
        canvas.width = w;
        canvas.height = h;
        //canvas.redraw();
    }

    window.onresize = () => setCanvasSize(window.innerWidth, window.innerHeight);
    // set it to fullscreen rn
    setCanvasSize(window.innerWidth, window.innerHeight);

    function snapzoneDrawer(base) {
        let objs = base.parent.children;
        objs.forEach(obj => {
            if (obj == base)
                return;
            let snapTop = canvas.display.rectangle({
                x: obj.x - snapZone,
                y: obj.y - snapZone,
                width: obj.width + snapZone * 2,
                height: snapZone * 3,
                stroke: "1px red",
                tag: "snapzone"
            });
            let snapBottom = canvas.display.rectangle({
                x: obj.x - snapZone,
                y: obj.y + obj.height - snapZone * 2,
                width: obj.width + snapZone * 2,
                height: snapZone * 3,
                stroke: "1px red",
                tag: "snapzone"
            });
            //TODO: add to obj
            canvas.addChild(snapTop);
            canvas.addChild(snapBottom);
        });
    }

    function snapZoneCleaner(base) {
        //TODO: clean children instead
        let objs = base.parent.children;
        let remove = [];
        objs.forEach(obj => {
            if (obj == base)
                return;
            if (obj.tag != "snapzone")
                return;
            remove.push(obj);
        });
        remove.forEach(r => r.remove());
    }

    function onDragStart() {
        snapzoneDrawer(this);
    }

    function onDragEnd() {
        snapZoneCleaner(this);
        snapHandler(this);
    }

    function snapHandler(base) {
        // snap handler
        //TODO: snap toggle
        console.log(base);
        let objs = base.parent.children;
        for (let i in objs) {
            let obj = objs[i];
            if (obj == base)
                continue;
            if (obj.tag != "track")
                continue;
            console.log(obj);
            //TODO: check if rotation matches
            //TODO: check collision with snapzone
            if (base.x >= obj.x - snapZone && base.x <= obj.x + obj.width + snapZone) {
                // top
                if (base.y + base.height >= obj.y - snapZone && // top line
                    base.y + base.height <= obj.y + snapZone * 2) { // bottom line with some extra margin
                    base.moveTo(obj.x, obj.y - obj.height + nobLength * 2);
                    break;
                }
                // bottom
                if (base.y >= obj.y + obj.height - snapZone * 2 && // top line, with some extra margin going inside
                    base.y <= obj.y + obj.height + snapZone) { // bottom line
                    base.moveTo(obj.x, obj.y + obj.height - nobLength * 2);
                    break;
                }
            }
        }
    }

    let dragOptions = {
        start: onDragStart, //FIXME: dont drag on right click
        end: onDragEnd,
    };
    // create imgs
    function addTrack(url, x, y) {
        let track = canvas.display.image({
            x: x,
            y: y,
            image: url,
            tag: "track"
        });
        canvas.addChild(track);
        track.dragAndDrop(dragOptions);
        track.bind("click", (e) => {
            if (e.button != 2)
                return;
            track.rotate(45);
            canvas.redraw();
        });
    }
    addTrack("assets/straight.png", 100, 80);
    addTrack("assets/start.png", 200, 80);
</script>
</html>